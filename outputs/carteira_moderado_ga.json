[
  {
    "TICKER":"FIQE",
    "SETOR":"Comunicações",
    "DY":0.0,
    "P\/L":1.2719761164,
    "P\/VP":1.0385343786,
    "P\/ATIVOS":1.3623373186,
    "MARGEM BRUTA":0.3754099999,
    "MARGEM EBIT":1.0834553483,
    "MARG. LIQUIDA":1.3026911984,
    "P\/EBIT":-1.1394623087,
    "EV\/EBIT":-1.0298303582,
    "DIVIDA LIQUIDA \/ EBIT":-0.2433237943,
    "DIV. LIQ. \/ PATRI.":0.6096989561,
    "PSR":1.3550810092,
    "P\/CAP. GIRO":1.0865699874,
    "P. AT CIR. LIQ.":1.3777231411,
    "LIQ. CORRENTE":1.4119386865,
    "ROE":1.2990743394,
    "ROA":1.3073060491,
    "ROIC":-0.510020894,
    "PATRIMONIO \/ ATIVOS":0.6695815734,
    "PASSIVOS \/ ATIVOS":-0.6328300986,
    "GIRO ATIVOS":null,
    "CAGR RECEITAS 5 ANOS":1.410545999,
    "CAGR LUCROS 5 ANOS":1.3233951057,
    "VPA":-0.8563437929,
    "LPA":-0.8266418635,
    "PEG RATIO":-0.210623579,
    "AVG_LIQUIDEZ":0.5927712828,
    "AVG_RENT":0.8965012083,
    "AVG_VALUE":0.6589402865,
    "AVG_GROWTH":0.8411058419,
    "AVG_DIV":0.0,
    "SCORE":0.6756357986
  },
  {
    "TICKER":"FLRY",
    "SETOR":"Saúde",
    "DY":1.4052030776,
    "P\/L":-0.0167905322,
    "P\/VP":0.3662676992,
    "P\/ATIVOS":0.2958895453,
    "MARGEM BRUTA":-0.6078325605,
    "MARGEM EBIT":0.5163755081,
    "MARG. LIQUIDA":0.4202970132,
    "P\/EBIT":0.1299649143,
    "EV\/EBIT":0.2513358012,
    "DIVIDA LIQUIDA \/ EBIT":-0.3020084894,
    "DIV. LIQ. \/ PATRI.":0.1736276724,
    "PSR":0.1605883958,
    "P\/CAP. GIRO":0.2580814342,
    "P. AT CIR. LIQ.":0.4416862345,
    "LIQ. CORRENTE":0.4190394884,
    "ROE":0.3986251894,
    "ROA":0.2104737732,
    "ROIC":0.2372338752,
    "PATRIMONIO \/ ATIVOS":0.0345544234,
    "PASSIVOS \/ ATIVOS":-0.0731972081,
    "GIRO ATIVOS":-0.5322549122,
    "CAGR RECEITAS 5 ANOS":0.3976505084,
    "CAGR LUCROS 5 ANOS":0.5020069997,
    "VPA":0.4162253215,
    "LPA":0.6828668447,
    "PEG RATIO":0.2113349901,
    "AVG_LIQUIDEZ":0.0968862238,
    "AVG_RENT":0.3566010718,
    "AVG_VALUE":0.190350341,
    "AVG_GROWTH":0.3703308327,
    "AVG_DIV":1.4052030776,
    "SCORE":0.3707015723
  },
  {
    "TICKER":"MOVI",
    "SETOR":"Consumo Cíclico",
    "DY":0.0,
    "P\/L":0.1380836977,
    "P\/VP":0.531092432,
    "P\/ATIVOS":1.1026758724,
    "MARGEM BRUTA":-0.9098921944,
    "MARGEM EBIT":0.3792253495,
    "MARG. LIQUIDA":-0.7559579178,
    "P\/EBIT":0.1035524278,
    "EV\/EBIT":0.1520092093,
    "DIVIDA LIQUIDA \/ EBIT":-0.2485772217,
    "DIV. LIQ. \/ PATRI.":4.9888020422,
    "PSR":1.3271225451,
    "P\/CAP. GIRO":-1.7199818828,
    "P. AT CIR. LIQ.":0.8526864309,
    "LIQ. CORRENTE":-1.0808318828,
    "ROE":-0.3185730871,
    "ROA":-0.786626334,
    "ROIC":0.2485929779,
    "PATRIMONIO \/ ATIVOS":-1.689652673,
    "PASSIVOS \/ ATIVOS":1.7777424692,
    "GIRO ATIVOS":-0.5057418023,
    "CAGR RECEITAS 5 ANOS":1.0023406675,
    "CAGR LUCROS 5 ANOS":-0.4457054101,
    "VPA":-0.5204338153,
    "LPA":-0.3277534413,
    "PEG RATIO":0.1381989326,
    "AVG_LIQUIDEZ":1.2197976459,
    "AVG_RENT":-0.2466678023,
    "AVG_VALUE":0.537076971,
    "AVG_GROWTH":0.2316113967,
    "AVG_DIV":0.0,
    "SCORE":0.3628841007
  },
  {
    "TICKER":"VULC",
    "SETOR":"Consumo Cíclico",
    "DY":1.1197275132,
    "P\/L":0.100765725,
    "P\/VP":-0.6580190751,
    "P\/ATIVOS":-2.8033969122,
    "MARGEM BRUTA":-0.1680988867,
    "MARGEM EBIT":0.3123156994,
    "MARG. LIQUIDA":0.4319201576,
    "P\/EBIT":0.1878151777,
    "EV\/EBIT":0.1647926781,
    "DIVIDA LIQUIDA \/ EBIT":-0.1298475002,
    "DIV. LIQ. \/ PATRI.":-0.5756836097,
    "PSR":-1.0865638659,
    "P\/CAP. GIRO":0.2147411704,
    "P. AT CIR. LIQ.":-2.7200407831,
    "LIQ. CORRENTE":1.0947674914,
    "ROE":0.3559960995,
    "ROA":1.7923769469,
    "ROIC":0.7036511043,
    "PATRIMONIO \/ ATIVOS":2.1546977428,
    "PASSIVOS \/ ATIVOS":-2.0774219142,
    "GIRO ATIVOS":1.636223478,
    "CAGR RECEITAS 5 ANOS":0.0658754896,
    "CAGR LUCROS 5 ANOS":0.3170719649,
    "VPA":-0.451001099,
    "LPA":0.0082617256,
    "PEG RATIO":0.7653201396,
    "AVG_LIQUIDEZ":0.1297454605,
    "AVG_RENT":0.7192520015,
    "AVG_VALUE":-0.3697561345,
    "AVG_GROWTH":0.3827558647,
    "AVG_DIV":1.1197275132,
    "SCORE":0.3018469831
  },
  {
    "TICKER":"VAMO",
    "SETOR":"Bens Industriais",
    "DY":0.5751884265,
    "P\/L":-0.1856011396,
    "P\/VP":0.4374428832,
    "P\/ATIVOS":0.8576837098,
    "MARGEM BRUTA":2.1610343951,
    "MARGEM EBIT":2.4097126673,
    "MARG. LIQUIDA":-0.1324496356,
    "P\/EBIT":-0.5853989756,
    "EV\/EBIT":-0.1417740263,
    "DIVIDA LIQUIDA \/ EBIT":-0.8467677873,
    "DIV. LIQ. \/ PATRI.":1.8485739089,
    "PSR":0.4900746715,
    "P\/CAP. GIRO":-0.2489270811,
    "P. AT CIR. LIQ.":0.7205190689,
    "LIQ. CORRENTE":-0.142797093,
    "ROE":-0.2871129605,
    "ROA":-0.8755839277,
    "ROIC":-0.165123407,
    "PATRIMONIO \/ ATIVOS":-1.2305954194,
    "PASSIVOS \/ ATIVOS":1.2855951423,
    "GIRO ATIVOS":-1.425197533,
    "CAGR RECEITAS 5 ANOS":0.5138553357,
    "CAGR LUCROS 5 ANOS":-0.5793561293,
    "VPA":-0.8039352211,
    "LPA":-0.9298560611,
    "PEG RATIO":-0.5792824296,
    "AVG_LIQUIDEZ":0.2863363429,
    "AVG_RENT":0.1898885473,
    "AVG_VALUE":0.1500355972,
    "AVG_GROWTH":-0.2149277411,
    "AVG_DIV":0.5751884265,
    "SCORE":0.1567815991
  },
  {
    "TICKER":"SAPR",
    "SETOR":"Utilidade Pública",
    "DY":0.0,
    "P\/L":0.3753605908,
    "P\/VP":0.8262405447,
    "P\/ATIVOS":0.0989664139,
    "MARGEM BRUTA":1.1056001365,
    "MARGEM EBIT":0.1794701577,
    "MARG. LIQUIDA":1.1488307952,
    "P\/EBIT":-0.3517242335,
    "EV\/EBIT":-0.649471815,
    "DIVIDA LIQUIDA \/ EBIT":0.8450748327,
    "DIV. LIQ. \/ PATRI.":-1.2064722728,
    "PSR":0.0361024971,
    "P\/CAP. GIRO":0.1630358047,
    "P. AT CIR. LIQ.":0.2980304726,
    "LIQ. CORRENTE":-0.0790007783,
    "ROE":0.2390277265,
    "ROA":1.0109461275,
    "ROIC":0.7404197653,
    "PATRIMONIO \/ ATIVOS":1.2957345023,
    "PASSIVOS \/ ATIVOS":-1.236211728,
    "GIRO ATIVOS":-0.474639473,
    "CAGR RECEITAS 5 ANOS":"""build_portfolios_summary.py
--------------------------------------------------
Pipeline único que
1. Aplica filtros de robustez aos dados fundamentalistas
   • DY negativo -> 0
   • Mantém somente empresas com ≥ 80 % das métricas preenchidas
2. Recalcula os scores via profiles.py
3. Executa o GA (ga.py) para obter as carteiras finais
4. Gera um arquivo JSON "summary_ga.json" com:
   {
     "perfil": {
        "num_assets": int,
        "hhi": float,
        "median_metrics": {...},
        "sector_weights": {"SETOR": pct, ...}
     },
     "universe": {"median_metrics": {...}}
   }

Métricas comparadas: Dividend Yield (DY), ROE, CAGR Receitas 5 Anos,
Liquidez Corrente, Dívida Líquida / EBIT.
"""
from pathlib import Path
import json
import pandas as pd
import profiles as pf
import ga

DATA_DIR = Path("data/processed")
OUT_DIR  = Path("outputs"); OUT_DIR.mkdir(exist_ok=True)

METRIC_COLS = [
    "DY",
    "ROE",
    "CAGR RECEITAS 5 ANOS",
    "LIQ. CORRENTE",
    "DIVIDA LIQUIDA / EBIT",
]

summary = {}

# -------- função auxiliar para filtrar robustez ---------

def robust_filter(df: pd.DataFrame) -> pd.DataFrame:
    # DY negativo vira zero
    if "DY" in df.columns:
        df["DY"] = df["DY"].clip(lower=0)

    # Retira linhas com >20 % NaN (considera apenas colunas métricas)
    metric_subset = df.drop(columns=["TICKER", "SETOR"], errors="ignore")
    mask_quality = metric_subset.notna().mean(axis=1) >= 0.80
    return df[mask_quality].reset_index(drop=True)

# -------- universo completo (para comparação) ---------
# usa o arquivo moderado como proxy; ele já tem filtros de cap/liq aplicados
df_universe = pd.read_csv(DATA_DIR / "fundamentals_clean_moderado.csv")
df_universe = robust_filter(df_universe)
summary["universe"] = {
    "median_metrics": df_universe[METRIC_COLS].median().to_dict()
}

# -------- processa cada perfil ---------
for perfil in ("conservador", "moderado", "arrojado"):
    df = pf.load_profile_data(perfil, DATA_DIR)
    df = robust_filter(df)

    rank = pf.build_scores(df, perfil)
    cart = ga.run_ga(rank, perfil)

    # salva carteira final
    outfile = OUT_DIR / f"carteira_{perfil}_ga.json"
    cart.to_json(outfile, orient="records", indent=2, force_ascii=False)

    # resumo quantitativo
    medians = cart[METRIC_COLS].median().to_dict()
    sector_weights = (
        cart["SETOR"].value_counts(normalize=True)  # porcentagens
            .round(3)
            .to_dict()
    )
    summary[perfil] = {
        "num_assets": len(cart),
        "hhi": round(cart.attrs["hhi"], 3),
        "median_metrics": medians,
        "sector_weights": sector_weights,
    }

# -------- grava summary ---------
with open(OUT_DIR / "summary_ga.json", "w", encoding="utf-8") as f:
    json.dump(summary, f, ensure_ascii=False, indent=2)

print("Resumo salvo em", OUT_DIR / "summary_ga.json")
-0.4076196699,
    "CAGR LUCROS 5 ANOS":0.3806901606,
    "VPA":-0.1827184005,
    "LPA":-0.0109927117,
    "PEG RATIO":-0.2453628787,
    "AVG_LIQUIDEZ":-0.1467994061,
    "AVG_RENT":0.6637389145,
    "AVG_VALUE":0.1470579544,
    "AVG_GROWTH":-0.0907641293,
    "AVG_DIV":0.0,
    "SCORE":0.1551865101
  },
  {
    "TICKER":"ODPV",
    "SETOR":"Saúde",
    "DY":1.42826263,
    "P\/L":-0.0064405264,
    "P\/VP":-2.1198135336,
    "P\/ATIVOS":-2.9077488316,
    "MARGEM BRUTA":0.4541837617,
    "MARGEM EBIT":1.7718070405,
    "MARG. LIQUIDA":1.7618243516,
    "P\/EBIT":0.471464927,
    "EV\/EBIT":0.208490783,
    "DIVIDA LIQUIDA \/ EBIT":0.2420952483,
    "DIV. LIQ. \/ PATRI.":-1.7768675338,
    "PSR":-1.9669059901,
    "P\/CAP. GIRO":-3.0862940502,
    "P. AT CIR. LIQ.":-2.4736458603,
    "LIQ. CORRENTE":-1.5076407287,
    "ROE":1.8399907256,
    "ROA":2.4981392692,
    "ROIC":1.3781575379,
    "PATRIMONIO \/ ATIVOS":1.7411198247,
    "PASSIVOS \/ ATIVOS":-1.7473115724,
    "GIRO ATIVOS":0.378762313,
    "CAGR RECEITAS 5 ANOS":-1.7606711492,
    "CAGR LUCROS 5 ANOS":0.4599959634,
    "VPA":-1.1505251446,
    "LPA":0.5647609439,
    "PEG RATIO":1.192643023,
    "AVG_LIQUIDEZ":-1.0141376714,
    "AVG_RENT":1.849983785,
    "AVG_VALUE":-0.9711673168,
    "AVG_GROWTH":-0.036010721,
    "AVG_DIV":1.42826263,
    "SCORE":0.1525007016
  },
  {
    "TICKER":"SBSP",
    "SETOR":"Utilidade Pública",
    "DY":0.0,
    "P\/L":0.1287517366,
    "P\/VP":-1.2809091602,
    "P\/ATIVOS":-2.2605519338,
    "MARGEM BRUTA":0.955712828,
    "MARGEM EBIT":0.4345598236,
    "MARG. LIQUIDA":0.6091067763,
    "P\/EBIT":-0.1287424176,
    "EV\/EBIT":-0.6575840092,
    "DIVIDA LIQUIDA \/ EBIT":1.1429501094,
    "DIV. LIQ. \/ PATRI.":-0.9680238973,
    "PSR":-0.4611609613,
    "P\/CAP. GIRO":1.4937729667,
    "P. AT CIR. LIQ.":-2.1307280149,
    "LIQ. CORRENTE":-0.6763147157,
    "ROE":0.9030186468,
    "ROA":1.6416784866,
    "ROIC":0.2425832066,
    "PATRIMONIO \/ ATIVOS":0.9902497593,
    "PASSIVOS \/ ATIVOS":-0.8878868765,
    "GIRO ATIVOS":0.557845625,
    "CAGR RECEITAS 5 ANOS":0.6002306862,
    "CAGR LUCROS 5 ANOS":1.0674804619,
    "VPA":2.5369317276,
    "LPA":3.2938031493,
    "PEG RATIO":-0.2472318934,
    "AVG_LIQUIDEZ":-0.1671295012,
    "AVG_RENT":0.766189388,
    "AVG_VALUE":-0.5677255985,
    "AVG_GROWTH":0.4734930849,
    "AVG_DIV":0.0,
    "SCORE":0.1108886641
  },
  {
    "TICKER":"FESA",
    "SETOR":"Materiais Básicos",
    "DY":0.0,
    "P\/L":-0.1637019082,
    "P\/VP":0.2466536623,
    "P\/ATIVOS":-0.8176362465,
    "MARGEM BRUTA":-0.4690614407,
    "MARGEM EBIT":-0.8528987761,
    "MARG. LIQUIDA":0.8315125659,
    "P\/EBIT":2.9834344225,
    "EV\/EBIT":1.0116830595,
    "DIVIDA LIQUIDA \/ EBIT":0.3388427138,
    "DIV. LIQ. \/ PATRI.":-0.8681149704,
    "PSR":-0.8572186277,
    "P\/CAP. GIRO":-0.3516291948,
    "P. AT CIR. LIQ.":-0.975020495,
    "LIQ. CORRENTE":0.5358549888,
    "ROE":0.3146970148,
    "ROA":0.6649639028,
    "ROIC":-0.5715346064,
    "PATRIMONIO \/ ATIVOS":1.544857519,
    "PASSIVOS \/ ATIVOS":-1.3544469742,
    "GIRO ATIVOS":-0.1009156646,
    "CAGR RECEITAS 5 ANOS":-0.000442516,
    "CAGR LUCROS 5 ANOS":-0.2563472767,
    "VPA":-0.317702999,
    "LPA":0.0983614104,
    "PEG RATIO":-0.2162364097,
    "AVG_LIQUIDEZ":0.0021942441,
    "AVG_RENT":0.0773480202,
    "AVG_VALUE":0.0593540465,
    "AVG_GROWTH":-0.1576754008,
    "AVG_DIV":0.0,
    "SCORE":0.0030792853
  },
  {
    "TICKER":"MDIA",
    "SETOR":"Consumo não Cíclico",
    "DY":0.0,
    "P\/L":-0.9866030183,
    "P\/VP":0.1795097756,
    "P\/ATIVOS":-0.5588649396,
    "MARGEM BRUTA":0.5042259086,
    "MARGEM EBIT":-0.4249665329,
    "MARG. LIQUIDA":0.3114492391,
    "P\/EBIT":0.666352566,
    "EV\/EBIT":0.8408852881,
    "DIVIDA LIQUIDA \/ EBIT":0.703519425,
    "DIV. LIQ. \/ PATRI.":-0.4884845987,
    "PSR":-0.3973680867,
    "P\/CAP. GIRO":-0.2345176328,
    "P. AT CIR. LIQ.":-0.4481881431,
    "LIQ. CORRENTE":0.8183532373,
    "ROE":0.1615004163,
    "ROA":0.3754089,
    "ROIC":-0.5793844733,
    "PATRIMONIO \/ ATIVOS":1.6591958412,
    "PASSIVOS \/ ATIVOS":-1.5793017786,
    "GIRO ATIVOS":-0.4078514681,
    "CAGR RECEITAS 5 ANOS":-0.6831947235,
    "CAGR LUCROS 5 ANOS":-0.9313642179,
    "VPA":1.1573743535,
    "LPA":0.1659247934,
    "PEG RATIO":0.1587799499,
    "AVG_LIQUIDEZ":0.3444626878,
    "AVG_RENT":-0.0311984901,
    "AVG_VALUE":-0.0908940103,
    "AVG_GROWTH":-0.4852596638,
    "AVG_DIV":0.0,
    "SCORE":-0.0586825203
  },
  {
    "TICKER":"MYPK",
    "SETOR":"Consumo Cíclico",
    "DY":0.0,
    "P\/L":0.0416789349,
    "P\/VP":0.8164791937,
    "P\/ATIVOS":0.9639987321,
    "MARGEM BRUTA":-1.8031428739,
    "MARGEM EBIT":-0.5379944373,
    "MARG. LIQUIDA":-0.7857079948,
    "P\/EBIT":0.1166952969,
    "EV\/EBIT":0.144380365,
    "DIVIDA LIQUIDA \/ EBIT":-0.2025670177,
    "DIV. LIQ. \/ PATRI.":0.4554203316,
    "PSR":1.3595210204,
    "P\/CAP. GIRO":-0.7383419573,
    "P. AT CIR. LIQ.":0.7537874076,
    "LIQ. CORRENTE":-0.5218474282,
    "ROE":-0.5132228704,
    "ROA":-0.7084338665,
    "ROIC":0.0417483751,
    "PATRIMONIO \/ ATIVOS":-0.6575118999,
    "PASSIVOS \/ ATIVOS":0.5626906597,
    "GIRO ATIVOS":1.4547009967,
    "CAGR RECEITAS 5 ANOS":-0.6648382975,
    "CAGR LUCROS 5 ANOS":-0.7153870893,
    "VPA":2.2208232347,
    "LPA":-0.1524411803,
    "PEG RATIO":0.2812265763,
    "AVG_LIQUIDEZ":-0.0896647048,
    "AVG_RENT":-0.5007221588,
    "AVG_VALUE":0.5905148785,
    "AVG_GROWTH":-0.3663329368,
    "AVG_DIV":0.0,
    "SCORE":-0.0687513484
  },
  {
    "TICKER":"BRAV",
    "SETOR":"Petróleo, Gás e Biocombustíveis",
    "DY":null,
    "P\/L":-2.7195154595,
    "P\/VP":1.4395671826,
    "P\/ATIVOS":0.8666515512,
    "MARGEM BRUTA":0.1064062148,
    "MARGEM EBIT":0.3322606427,
    "MARG. LIQUIDA":-0.4065354696,
    "P\/EBIT":-0.6944740398,
    "EV\/EBIT":-0.1540382565,
    "DIVIDA LIQUIDA \/ EBIT":0.045229961,
    "DIV. LIQ. \/ PATRI.":-0.1830057977,
    "PSR":0.0598184476,
    "P\/CAP. GIRO":0.6617142274,
    "P. AT CIR. LIQ.":1.0482940816,
    "LIQ. CORRENTE":-0.7656982732,
    "ROE":0.0951641883,
    "ROA":-0.5569826307,
    "ROIC":0.3005617919,
    "PATRIMONIO \/ ATIVOS":-0.4444292011,
    "PASSIVOS \/ ATIVOS":0.7743069805,
    "GIRO ATIVOS":-0.7420851728,
    "CAGR RECEITAS 5 ANOS":2.687534548,
    "CAGR LUCROS 5 ANOS":null,
    "VPA":0.7248230349,
    "LPA":-0.4691895417,
    "PEG RATIO":-2.8278059856,
    "AVG_LIQUIDEZ":-0.3011580366,
    "AVG_RENT":-0.0471062955,
    "AVG_VALUE":-0.3435420215,
    "AVG_GROWTH":-0.0701357188,
    "AVG_DIV":null,
    "SCORE":null
  }
]